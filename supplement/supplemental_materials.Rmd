---
title: 'Supplemental Materials: Time-varying responses of lake metabolism to light and temperature'
fontsize: 12pt
geometry: margin=1in,letterpaper
documentclass: article
mainfont: "Times New Roman"
mathfont: "Times New Roman"
graphics: true
colorlinks: true
supplemental: true
mathspec: true
author:
   - name: Joseph Phillips
affil:
   - name: Department of Integrative Biology, University of Wisconsin--Madison
output:
    bookdown::pdf_document2:
        fig_caption: yes
        number_sections: yes
        template: template.tex
        latex_engine: xelatex
        toc: yes
        toc_depth: 2
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, cache = FALSE}
# load packages
suppressPackageStartupMessages({
  library(knitr)
  library(bookdown)
  library(tidyverse)  
})

# set directory
knitr::opts_knit$set(root.dir = normalizePath(".."))

# set theme
theme_set(theme_bw() %+replace% 
            theme(panel.grid = element_blank(),
                  strip.background = element_blank(),
                  legend.margin = margin(0,0,0,0),
                  strip.text = element_text(size=10),
                  legend.text = element_text(size=10),
                  axis.text=element_text(size=10, color="black"),
                  axis.title.y=element_text(angle = 90 ,margin=margin(0,15,0,0)),
                  axis.title.x=element_text(margin=margin(15,0,0,0))))
```

# Model fitting
## Scaling the model
### NEP
For fitting the model, I z-scored (centered on the mean and divided by the standard deviation) the observed DO concentrations and scaled the model accordingly. I then nondimensionalized the scaled model to remove the scale parameters (mean/standard deviation for the observed DO and mixing depth). This put the observed values and model parameters on unit scale, which improved the computaitonal efficiency and allowed for the use for weakly-informative priors on unit scale. I then back-transformed the scaled parameters to recover their values on the original scale.

The model for DO dynamics (eqn X in the main text) is:
$$
DO_{t+1} = DO_t+ \frac{\Delta h}{z_{mix}} \left(NEP_t+k_t(DO^{eq}_t-DO_t) \right)+\epsilon^{proc}_t
$$

where $DO_t$ is the DO concentration [$mg~O_2~m^{-3}$], $DO^{eq}_t$ is the DO concentration at saturation [$mg~O_2~m^{-3}$], $\Delta h$ = 1 hour, $NEP_t$ is the net ecosystem production [$mg~O_2~m^{-2}~h^{-1}$], $k$ [$m~h^{-1}$] is the rate of oxygen exchange, $z_{mix}$ is the mixing depth [$3.3m$], and $\epsilon_{proc}$ is the processes error [$mg~O_2~m^{-3}$]. For simplicity, only a single time index $t$ is used, rather than indexing by hour and day as in the main text.

For clarity, $DO$ is replaced with $y$ and $NEP$ with $\phi$, yielding

$$
y_{t+1} = y_t+ \frac{\Delta h}{z_{mix}}\left(\phi_t+k_t(y^{eq}_t-y_t) \right)+\epsilon^{proc}_t.
$$

Z-scoring the observed DO values by the mean ($\mu$) and standard deviation ($\tau$) of the full set of DO observations implies the following scaling of the model:

$$
\frac{y_{t+1}-\mu}{\tau} = \frac{1}{\tau} \left(y_t - \mu + \frac{\Delta h}{z_{mix}} \left(\phi_t+k_t(y^{eq}_t-y_t) \right)+\epsilon^{proc}_t \right)
$$

which can be expanded as

$$
= \frac{1}{\tau} y_t - \frac{1}{\tau}\mu + \frac{1}{\tau}\frac{\Delta h}{z_{mix}}\phi_t + \frac{1}{\tau} \frac{\Delta h}{z_{mix}} k_t (y^{eq}_t-y_t) + \frac{1}{\tau}\epsilon^{proc}_t. 
$$

Rearranging to express all "$y$" terms to resemble the lefthand side yields

$$
\frac{y_{t+1}-\mu}{\tau} = \frac{y_t-\mu}{\tau} + \frac{1}{\tau}\frac{\Delta h}{z_{mix}}\phi_t + \frac{\Delta h}{z_{mix}} k_t\left( \left(\frac{y^{eq}_t-\mu}{\tau} + \frac{\mu}{\tau} \right)- \left(\frac{y_t-\mu}{\tau} + \frac{\mu}{\tau}\right) \right) + \frac{1}{\tau}\epsilon^{proc}_t
$$

which simplifies to 

$$
\frac{y_{t+1}-\mu}{\tau} = \frac{y_t-\mu}{\tau} + \frac{1}{\tau}\frac{\Delta h}{z_{mix}}\phi_t + \frac{\Delta h}{z_{mix}} k_t\left( \frac{y^{eq}_t-\mu}{\tau} - \frac{y_t-\mu}{\tau} \right) + \frac{1}{\tau}\epsilon^{proc}_t. 
$$

Substituting with nondimesionalized variables yields

$$
x_{t+1} = x_t + \hat{\phi_t} + \hat{k}_t (x^{eq}_t - x_t) + \hat{\epsilon}^{proc}_t
$$
where 

\begin{equation}
\begin{split}
&x_t = \frac{y_t-\mu}{\tau}  \\
&x^{eq}_t = \frac{y^{eq}_t-\mu}{\tau} \\
&\hat{\phi}_t = \frac{1}{\tau}\frac{\Delta h}{z_{mix}}\phi_t \\
&\hat{k}_t = \frac{\Delta h}{z_{mix}} k_t \\
&\hat{\epsilon}^{proc}_t = \frac{1}{\tau}\epsilon^{proc}_t
\end{split}
\end{equation}

The parameter values on the original scale can be obtained by back-transforming the nondimensionlized values. For example, $\phi_t = \tau\frac{z_{mix}}{\Delta h} \hat{\phi}_t$.

###GPP and ER
NEP ($\phi_t$) is the difference between GPP and ER. Therefore, the scaling of NEP implies that GPP (denoted $\chi$) and ER (denoted $\kappa$) are scaled as 

\begin{equation}
\begin{split}
\hat{\chi}_t = \frac{1}{\tau}\frac{\Delta h}{z_{mix}}\chi_t\\
\hat{\kappa}_t = \frac{1}{\tau}\frac{\Delta h}{z_{mix}}\kappa_t\\
\end{split}
\end{equation}

The original equation for $\chi$ (main text eqn X) is

$$
\chi_t = \beta_{d}~\text{tanh} \left( \frac{\alpha_t}{\beta_t}L_t\right)  
$$ 

where $\beta_t$ is the maximum rate of GPP [$mg~O_2~m^{-3}~h^{-1}$] on a particular day and $\alpha$ [$mg~O_2~s~\mu mol~photons^{-1}~m^{-1}~h^{-1}$] is the rate at which GPP increases with $L_t$. This is scaled as

$$
\hat{\chi}_t = \frac{1}{\tau}\frac{\Delta h}{z_{mix}}\beta_t~\text{tanh} \left( \frac{\frac{\lambda}{\tau}\frac{\Delta h}{z_{mix}}\alpha_t}{\frac{1}{\tau}\frac{\Delta h}{z_{mix}}\beta_t}\frac{L_t}{\lambda}\right)  
$$ 

where $\lambda$ is the mean light level (so that $\alpha_t$ can be expressed on unit scale). This simplifies to 

$$
\hat{\chi}_t = \hat{\beta}_t~\text{tanh} \left( \frac{\hat{\alpha}_t}{\hat{\beta}_t}\hat{L}_t\right)  
$$ 

where 
\begin{equation}
\begin{split}
&\hat{\beta}_t = \frac{1}{\tau}\frac{\Delta h}{z_{mix}}\beta_t\\
&\hat{\alpha}_t = \frac{\lambda}{\tau}\frac{\Delta h}{z_{mix}}~\alpha_t\\
&\hat{L}_t = \frac{L_t}{\lambda}.
\end{split}
\end{equation}

This scaling can be applied by direct analogy to ER and to the time varying components of $\beta_t$, $\alpha_t$, and $\rho_t$ (main text eqns X-X)

## Priors

I fit the model using weakly informative priors based on normal distributions (see http://mc-stan.org/users/documentation/case-studies/weakly_informative_shapes.html). Because the parameters were fit on unit scale, I was generally used priors with standard deviations of 1 and means of 0. However, because the parameters describing the scaling of GPP and ER with temperature ($\gamma_\beta$ and $\gamma_\rho$) had lower bounds of 1, I used corresponding priors with means of 1. For those parameters with lower bounds (1 for $\gamma_\beta$ and $\gamma_\rho$ and 0 for all standard deviations), I used normal priors truncated at their respective lower bounds. 

## Estimating of observation error

Attempting to estimate the standard deviaitons for observation error ($\sigma_{obs}$) and process error ($\sigma_{proc}$) independently resulted in very inefficient sampling of the posterior distribution as $\sigma_{obs}$ slowly converged to 0. This can be seen by examining the parameter trace plots from the MCMC (Fig \ref{fig:trace}). While $\sigma_{proc}$ showed good mixing across all four chains, the chains for $\sigma_{proc}$ did not mix indicating a lack of convergence. However, the overall magnitude of $\sigma_{obs}$ was close to 0 and the lack of convergence is likely due to difficulties associated with estimating the parameter when near it's boundary.

Therefore, I refit the model fixing $\sigma_{obs}$ to near 0 (1% of the observed standard deviation in obseved DO, so that I could use the same model specification in Stan). This resulted in nearly identical estimates for the parameters (Fig \ref{fig:posts-sig-obs}). 

```{r trace, echo = FALSE, message = FALSE, cache = FALSE, fig.height=4, fig.width=6, fig.cap="Trace plots for standard deviations of observation and process error from the MCMC. Colors indicate separately initialized chains."}
# plot
read_csv("analyses/model_fit/output/sig_obs/fixed_pars_full.csv") %>%
  select("chain","step","sig_obs","sig_proc") %>%
  rename("sigma[obs]" = "sig_obs", "sigma[proc]" = "sig_proc") %>%
  gather(par, value, -chain, -step) %>%
  ggplot(aes(step, value, color=factor(chain)))+
  facet_wrap(~par, scales="free_y", labeller = label_parsed)+
  geom_line(alpha=0.4)+
  scale_color_manual(values=c("blue","black","orange","red")) +
  ylab("Value")+
  xlab("Iteration")+
  guides(color = F)
```

```{r posts-sig-obs, echo = FALSE, message = FALSE, cache = FALSE, fig.height=6, fig.width=6, fig.cap="Posterior distributions for parameter estimates, with the standard deviation of observation error estimated from data or fixed to 0."}
# plot
read_csv("analyses/model_fit/output/sig_obs/fixed_pars_full.csv") %>%
  select(-"lp__",-"sig_obs") %>%
  mutate(type = "Estimated") %>%
  bind_rows(read_csv("analyses/model_fit/output/fixed_pars_full.csv") %>%
  select(-"lp__") %>%
  mutate(type = "Fixed to 0")) %>%
  rename("gamma[beta]" = "gamma_1", "gamma[rho]" = "gamma_2",
         "sigma[alpha]" = "sig_a", "sigma[beta[0]]" = "sig_b0",
         "sigma[rho]" = "sig_r", "sigma[proc]" = "sig_proc") %>%
  gather(var, value, -step, -chain, -type) %>%
  ggplot(aes(value, linetype = type))+
  facet_wrap(~var, scales = "free", labeller = label_parsed)+
  stat_density(aes(linetype = type), position = "identity", geom = "line")+
  scale_y_continuous("Posterior Probability Density", breaks=NULL)+
  scale_x_continuous("Value", breaks=NULL)+
  scale_linetype_manual(expression(sigma[obs]), values=c(1,2))+
  theme(legend.position="top", legend.direction = "vertical")
```

\clearpage

## Stan specifications and diagnostics

Detailed explanation of code for specifying, fitting, and diagnosing the model with Stan can be found at: 

# Simulations
## Methods
## Results

# Surface vs. average water column PAR
## Methods
## Results
